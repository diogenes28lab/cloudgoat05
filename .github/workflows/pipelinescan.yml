name: Veracode Pipeline Scan  üõ†Ô∏è

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Zip Project
        run: zip -r project.zip .
        env:
          build-name: project.zip

      - name: Archive package
        uses: actions/upload-artifact@v4
        with:
          name: CodePackage
          path: project.zip

      - name: Upload & Scan
        uses: veracode/veracode-uploadandscan-action@0.2.6
        with:
          appname: 'cloudgoad'
          filepath: 'project.zip'
          vid: "${{ secrets.VERACODE_API_ID }}"
          vkey: "${{ secrets.VERACODE_API_KEY }}"

  pipeline-scan:
    needs: build
    runs-on: ubuntu-latest
    container:
      image: veracode/pipeline-scan:latest
      options: --user root

    steps:
      - name: Retrieve artifact
        uses: actions/download-artifact@v4
        with:
          name: CodePackage

      - name: Pipeline Scan
        run: |
          java -jar /opt/veracode/pipeline-scan.jar \
          --veracode_api_id="${{ secrets.VERACODE_API_ID }}" \
          --veracode_api_key="${{ secrets.VERACODE_API_KEY }}" \
          --fail_on_severity="Very High, High" \
          --file="project.zip" \
          --app_id="${{ secrets.VERACODE_APP_ID }}" \
          --json_output_file="results.json"
        continue-on-error: true

      - name: Upload Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: ScanResults
          path: results.json

  results_to_sarif:
    needs: pipeline-scan
    runs-on: ubuntu-latest
    steps:
      - name: Get scan results
        uses: actions/download-artifact@v4
        with:
          name: ScanResults

      - name: Convert pipeline scan output to SARIF format
        id: convert
        uses: Veracode/veracode-pipeline-scan-results-to-sarif@v1.0.7
        with:
          pipeline-results-json: results.json
          output-results-sarif: results.sarif
